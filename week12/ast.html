<script>
  // token number .1234567890
  // operator: +、-、*、/
  // whitesplace:<sp>
  // lineterminator: <lf> <cr>
  /* let reg = /^[\+\-]?(0\.?$|([1-9]\d*\.?\d*|0?\.\d+)([eE][\+\-]\d+)?$/; */
  let regex = /([0-9\.]+)|([ ]+)|([\r\n]+)|(\+)|(\-)|(\*)|(\/)/g; // 小括号出
  let dictionary = ['Number', 'Whitespace', 'LineTerminator', '+', '-', '*', '/'];

  function* tokenize(source) { // 换成状态机
    let result = null;
    let lastIndex = 0;
    while(true) {
      // 匹配
      lastIndex = regex.lastIndex;
      result = regex.exec(source);

      // 判断
      if (!result) break;
      if(regex.lastIndex - lastIndex > result[0].length){
        throw new Error('Unexpected token \"' + source.slice(lastIndex, regex.lastIndex  - result[0].length) + '\"！')
      }

      // 生成token
      let token = {
        type: null,
        value: null
      }

      for (let i = 0; i < dictionary.length; i++) {
        if (result[i + 1]) {
          token.type = (dictionary[i]);
        }
      }
      token.value = (result[0]);
      yield token;
    } 
    yield {type: "EOF"};

  }

  function Expression(source){
    if(source[0].type === "AdditiveExpression" && source[1].type === "EOF"){
      let node = {
        type: "Expression",
        children:[source.shift(), source.shift()]
      }
      source.unshift(node);
      return source;
    }
    AdditiveExpression(source);
    return Expression(source);
  }

  function AdditiveExpression(source){
    if(source[0].type === "Number"){ // 
      MultiplicativeExpression(source);
      return AdditiveExpression(source);
    }

    if(source[0].type === "MultiplicativeExpression" ){ // 第一个是 MultiplicativeExpression
      let node = {
        type: 'AdditiveExpression',
        children: [source.shift()]
      }
      source.unshift(node);
      return AdditiveExpression(source);
    }

    if(source[0].type === "AdditiveExpression" && source.length > 1 && source[1].type === "+"){
      let node = {
        type:"AdditiveExpression",
        children:[source.shift(), source.shift()]
      }
      MultiplicativeExpression(source);
      node.children.push(source.shift());
      source.unshift(node);
      return AdditiveExpression(source);

    }

    if(source[0].type === "AdditiveExpression" && source.length > 1 && source[1].type === "-"){
      let node = {
        type:"AdditiveExpression",
        children:[source.shift(), source.shift()]
      }
      MultiplicativeExpression(source);
      node.children.push(source.shift());
      source.unshift(node);
      return AdditiveExpression(source);
    }

    if(source[0].type === "AdditiveExpression"){
      return source[0];
    }
  }

  function MultiplicativeExpression(source){
    if(source[0].type === "Number"){ // 第一个是number
      let node = {
        type: 'MultiplicativeExpression',
        children: source.shift()
      }
      source.unshift(node);
      return MultiplicativeExpression(source)
    }
    if(source[0].type === "MultiplicativeExpression" && source.length > 1 && source[1].type === "*" ){ // 第一个是 MultiplicativeExpression
      let node = {
        type: 'MultiplicativeExpression',
        children: [source.shift(), source.shift(), source.shift()]
      }
      source.unshift(node);
      return MultiplicativeExpression(source)
    }

    if(source[0].type === "MultiplicativeExpression" && source.length > 1 && source[1].type === "/" ){
      let node = {
        type: 'MultiplicativeExpression',
        children: [source.shift(), source.shift(), source.shift()]
      }
      source.unshift(node);
      return MultiplicativeExpression(source)
    }

    if(source[0].type === "MultiplicativeExpression"){
      return source[0];
    }
    throw new Error();
  }

  let source = [];

  for (let token of tokenize("5 + 10 * 25")) {
    if(token.type !== "Whitespace" && token.type !== "LineTerminator"){
      source.push(token);
    }
  }

  console.log(Expression(source));
</script>